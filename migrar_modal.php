<?php
require_once 'config.php';
checkAuth();

// Inicializar sistema de log
$log_file = initLogSystem();

// Fun√ß√£o de log melhorada
function log_message($message) {
    global $log_file;
    $timestamp = date('Y-m-d H:i:s');
    echo "[$timestamp] $message\n";
    
    // Tamb√©m salvar no arquivo
    safeLogWrite($message, $log_file);
    
    flush();
    ob_flush();
}

// Limpar log anterior
safeLogWrite("=== NOVA MIGRA√á√ÉO INICIADA ===", $log_file);
safeLogWrite("Usu√°rio: " . $_SESSION['username'], $log_file);
safeLogWrite("Data/Hora: " . date('d/m/Y H:i:s'), $log_file);

log_message("=== INICIANDO PROCESSO DE MIGRA√á√ÉO ===");
log_message("Usu√°rio: " . $_SESSION['username'] . " (" . $_SESSION['user_level'] . ")");
log_message("Sistema: " . PHP_OS);
log_message("Diret√≥rio: " . __DIR__);

// Verificar se temos POST data
if ($_POST) {
    log_message("üìù Dados recebidos: " . print_r($_POST, true));
} else {
    log_message("‚ö†Ô∏è Nenhum dado POST recebido");
}

try {
    // Verifica√ß√£o r√°pida das conex√µes antes de iniciar
    log_message("üîç Verificando conex√µes...");
    
    $source_test = testConnection(DB_SOURCE_HOST, DB_SOURCE_NAME, DB_SOURCE_USER, DB_SOURCE_PASS, DB_SOURCE_PORT);
    log_message("‚úÖ Conex√£o com origem: OK - " . $source_test['version']);
    
    $target_test = testConnection(DB_TARGET_HOST, DB_TARGET_NAME, DB_TARGET_USER, DB_TARGET_PASS, DB_TARGET_PORT);
    log_message("‚úÖ Conex√£o com destino: OK - " . $target_test['version']);
    
} catch (Exception $e) {
    log_message("‚ùå Falha na verifica√ß√£o de conex√µes: " . $e->getMessage());
    log_message("=== MIGRA√á√ÉO CANCELADA ===");
    
    echo "MIGRATION_FAILED: " . $e->getMessage();
    exit;
}

try {
    // Conectar aos bancos
    log_message("üîå Conectando ao banco de origem...");
    $source_pdo = connectDB(DB_SOURCE_HOST, DB_SOURCE_NAME, DB_SOURCE_USER, DB_SOURCE_PASS, DB_SOURCE_PORT);
    log_message("‚úÖ Conex√£o com origem estabelecida");

    log_message("üîå Conectando ao banco de destino...");
    $target_pdo = connectDB(DB_TARGET_HOST, DB_TARGET_NAME, DB_TARGET_USER, DB_TARGET_PASS, DB_TARGET_PORT);
    log_message("‚úÖ Conex√£o com destino estabelecida");

    // Lista de tabelas para migrar
    $tables = getConfiguredTables();
    
    if (empty($tables)) {
        log_message("‚ùå Nenhuma tabela configurada para migra√ß√£o");
        log_message("=== MIGRA√á√ÉO CANCELADA ===");
        echo "MIGRATION_FAILED: Nenhuma tabela configurada";
        exit;
    }
    
    log_message("üìã Tabelas selecionadas: " . implode(', ', $tables));
    
    // Verificar modo de opera√ß√£o
    $truncate_mode = isset($_POST['truncate']) && $_POST['truncate'] == '1';
    if ($truncate_mode) {
        log_message("üóëÔ∏è MODO: ESVAZIAMENTO DE TABELAS ATIVADO");
    } else {
        log_message("üíæ MODO: MIGRA√á√ÉO COM DADOS EXISTENTES");
    }
    
    // Iniciar transa√ß√£o no destino
    $target_pdo->beginTransaction();
    log_message("üîÑ Transa√ß√£o iniciada no banco de destino");

    $total_tables = count($tables);
    $processed_tables = 0;
    $success_tables = 0;
    $total_records = 0;

    foreach ($tables as $table) {
        $processed_tables++;
        log_message("\n--- Processando tabela {$processed_tables}/{$total_tables}: $table ---");
        
        // Verificar se tabela existe na origem
        try {
            $check_table = $source_pdo->query("SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = '$table')");
            $table_exists_origin = $check_table->fetchColumn();
        } catch (Exception $e) {
            log_message("‚ùå Erro ao verificar tabela na origem: " . $e->getMessage());
            continue;
        }
        
        if (!$table_exists_origin) {
            log_message("‚ö†Ô∏è Tabela $table n√£o existe na origem");
            continue;
        }
        
        log_message("‚úÖ Tabela encontrada na origem");

        // Verificar se tabela existe no destino
        try {
            $check_table_dest = $target_pdo->query("SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_name = '$table')");
            $table_exists_dest = $check_table_dest->fetchColumn();
        } catch (Exception $e) {
            log_message("‚ùå Erro ao verificar tabela no destino: " . $e->getMessage());
            continue;
        }

        if (!$table_exists_dest) {
            log_message("üèóÔ∏è Criando tabela $table no destino...");
            if (!createTableStructure($source_pdo, $target_pdo, $table)) {
                log_message("‚ùå Falha ao criar tabela $table");
                continue;
            }
        } else {
            log_message("‚úÖ Tabela $table j√° existe no destino");
        }

        // Esvaziar tabela de destino se solicitado
        if ($truncate_mode) {
            log_message("üóëÔ∏è Esvaziando tabela...");
            try {
                $target_pdo->exec("TRUNCATE TABLE \"$table\"");
                log_message("‚úÖ Tabela $table esvaziada");
            } catch (Exception $e) {
                log_message("‚ö†Ô∏è N√£o foi poss√≠vel esvaziar tabela: " . $e->getMessage());
            }
        }

        // Obter dados da tabela de origem
        log_message("üì• Extraindo dados...");
        try {
            $stmt = $source_pdo->query("SELECT * FROM \"$table\"");
            $rows = $stmt->fetchAll(PDO::FETCH_ASSOC);
            $row_count = count($rows);
        } catch (Exception $e) {
            log_message("‚ùå Erro ao extrair dados: " . $e->getMessage());
            continue;
        }
        
        log_message("üìä $row_count registros encontrados");

        if ($row_count > 0) {
            // Obter colunas
            $columns = array_keys($rows[0]);
            $columns_str = '"' . implode('", "', $columns) . '"';
            $placeholders = ':' . implode(', :', $columns);
            
            // Preparar INSERT para destino
            $insert_sql = "INSERT INTO \"$table\" ($columns_str) VALUES ($placeholders)";
            
            try {
                $insert_stmt = $target_pdo->prepare($insert_sql);
            } catch (Exception $e) {
                log_message("‚ùå Erro ao preparar INSERT: " . $e->getMessage());
                continue;
            }
            
            $inserted = 0;
            $errors = 0;
            
            foreach ($rows as $index => $row) {
                try {
                    $insert_stmt->execute($row);
                    $inserted++;
                    
                    // Log a cada 100 registros
                    if ($inserted % 100 === 0) {
                        log_message("   üì¶ Progresso: $inserted/$row_count");
                    }
                } catch (Exception $e) {
                    $errors++;
                    if ($errors <= 2) {
                        log_message("   ‚ö†Ô∏è Erro no registro $index: " . $e->getMessage());
                    }
                }
            }
            
            $total_records += $inserted;
            log_message("‚úÖ $inserted registros inseridos em $table");
            
            if ($errors > 0) {
                log_message("‚ö†Ô∏è  $errors erros em $table");
            }
            
            $success_tables++;
        } else {
            log_message("‚Ñπ Nenhum dado para migrar em $table");
            $success_tables++;
        }
    }

    // Commit da transa√ß√£o
    $target_pdo->commit();
    log_message("\nüéâ MIGRA√á√ÉO CONCLU√çDA!");
    log_message("üìä RESUMO FINAL:");
    log_message("   ‚Ä¢ Tabelas processadas: $success_tables/$total_tables");
    log_message("   ‚Ä¢ Registros migrados: $total_records");
    log_message("   ‚Ä¢ Modo: " . ($truncate_mode ? "Esvaziar e migrar" : "Migrar com dados existentes"));
    log_message("=== MIGRA√á√ÉO FINALIZADA ===");
    
    echo "MIGRATION_COMPLETED:$success_tables:$total_tables:$total_records";

} catch (Exception $e) {
    // Rollback em caso de erro
    if (isset($target_pdo)) {
        try {
            $target_pdo->rollBack();
            log_message("üîÑ Transa√ß√£o revertida");
        } catch (Exception $rollback_e) {
            log_message("‚ö†Ô∏è Erro ao reverter transa√ß√£o: " . $rollback_e->getMessage());
        }
    }
    log_message("\n‚ùå ERRO CR√çTICO: " . $e->getMessage());
    log_message("=== MIGRA√á√ÉO INTERROMPIDA ===");
    
    echo "MIGRATION_FAILED:" . $e->getMessage();
}

/**
 * Fun√ß√£o para criar a estrutura da tabela no destino
 */
function createTableStructure($source_pdo, $target_pdo, $table) {
    try {
        // Obter informa√ß√µes das colunas
        $columns_info = $source_pdo->query("
            SELECT 
                column_name,
                data_type,
                is_nullable,
                column_default,
                character_maximum_length
            FROM information_schema.columns 
            WHERE table_name = '$table' 
            ORDER BY ordinal_position
        ")->fetchAll(PDO::FETCH_ASSOC);
        
        if (empty($columns_info)) {
            log_message("   ‚ùå N√£o foi poss√≠vel obter colunas da tabela $table");
            return false;
        }
        
        $column_definitions = [];
        foreach ($columns_info as $col) {
            $definition = "\"{$col['column_name']}\" {$col['data_type']}";
            
            // Adicionar tamanho para tipos character
            if ($col['character_maximum_length']) {
                $definition .= "({$col['character_maximum_length']})";
            }
            
            // Adicionar NOT NULL
            if ($col['is_nullable'] === 'NO') {
                $definition .= " NOT NULL";
            }
            
            // Adicionar valor padr√£o
            if ($col['column_default']) {
                $definition .= " DEFAULT {$col['column_default']}";
            }
            
            $column_definitions[] = $definition;
        }
        
        $create_sql = "CREATE TABLE \"$table\" (\n    " . implode(",\n    ", $column_definitions) . "\n)";
        
        // Executar CREATE TABLE
        $target_pdo->exec($create_sql);
        log_message("   ‚úÖ Tabela $table criada com sucesso");
        return true;
        
    } catch (Exception $e) {
        log_message("   ‚ùå Erro ao criar tabela $table: " . $e->getMessage());
        return false;
    }
}
?>